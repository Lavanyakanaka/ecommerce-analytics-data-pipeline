services:
	postgres:
		image: postgres:15
		environment:
			POSTGRES_DB: ${DB_NAME}
			POSTGRES_USER: ${DB_USER}
			POSTGRES_PASSWORD: ${DB_PASSWORD}
		ports:
			- "5432:5432"
		healthcheck:
			test: ["CMD-SHELL", "pg_isready -U ${DB_USER} -d ${DB_NAME}"]
			interval: 5s
			timeout: 5s
			retries: 10
		volumes:
			- postgres_data:/var/lib/postgresql/data

	pipeline:
		build:
			context: ..
			dockerfile: docker/Dockerfile
		env_file:
			- ../.env
		depends_on:
			postgres:
				condition: service_healthy
		volumes:
			- ../data:/app/data
			- ../logs:/app/logs
		command: ["python", "-m", "scripts.pipeline_orchestrator"]

volumes:
	postgres_data:
